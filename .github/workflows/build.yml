name: iVPN Final Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
#  build-windows:
#    runs-on: windows-latest
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Cache Pub Dependencies
#        uses: actions/cache@v4
#        with:
#          path: C:\Users\runneradmin\AppData\Local\Pub\Cache
#          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
#
#      - uses: subosito/flutter-action@v2
#        with:
#          channel: 'stable'
#          cache: true
#
#      - name: Cache Windows Assets
#        id: assets-cache
#        uses: actions/cache@v4
#        with:
#          path: assets/executables/windows
#          key: windows-assets-v1
#
#      - name: Setup Core Assets (Download Binaries)
#        if: steps.assets-cache.outputs.cache-hit != 'true'
#        run: |
#          flutter pub get
#          dart run tool/setup_core.dart
#
#      - name: Build iVPN Windows
#        run: |
#          flutter pub get
#          flutter build windows --release
#
#      - name: Bundle VC++ Runtime DLLs
#        shell: pwsh
#        run: |
#          $buildDir = "build/windows/x64/runner/Release"
#          Copy-Item "C:\Windows\System32\msvcp140.dll" -Destination $buildDir
#          Copy-Item "C:\Windows\System32\vcruntime140.dll" -Destination $buildDir
#          Copy-Item "C:\Windows\System32\vcruntime140_1.dll" -Destination $buildDir
#
#      - name: Compress Windows Release
#        shell: pwsh
#        run: Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath ivpn-windows.zip -Force
#
#      - name: Create Release and Upload Windows
#        uses: softprops/action-gh-release@v1
#        if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
#        with:
#          tag_name: v1.0.${{ github.run_number }}
#          name: Release v1.0.${{ github.run_number }}
#          files: ivpn-windows.zip
#          draft: false
#          prerelease: false
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache Flutter
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Clean Build
        run: flutter clean

      - name: Cache Android Assets
        id: android-assets-cache
        uses: actions/cache@v4
        with:
          path: assets/executables/android
          key: android-assets-v1.10.1

      - name: Setup Core Assets (Download Binaries)
        if: steps.android-assets-cache.outputs.cache-hit != 'true'
        run: |
          flutter pub get
          dart run tool/setup_core.dart

      - name: Cache AARs
        id: aar-cache
        uses: actions/cache@v4
        with:
          path: android/app/libs
          key: ${{ runner.os }}-aar-${{ hashFiles('android/app/build.gradle.kts') }}

      - name: Download all local dependencies
        if: steps.aar-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p android/app/libs
          curl -L "https://raw.githubusercontent.com/singbox-android/libbox/refs/heads/main/libbox.aar" -o android/app/libs/libbox.aar

      - name: Verify AARs
        run: ls -lh android/app/libs/

      - name: Build APK
        run: |
          flutter pub get
          yes | flutter doctor --android-licenses || true
          flutter build apk --release --target-platform android-arm64

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/iVPN.apk

      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          files: build/app/outputs/flutter-apk/iVPN.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
