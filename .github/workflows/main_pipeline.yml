name: iVPN Final Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      android: ${{ steps.filter.outputs.android }}
      windows: ${{ steps.filter.outputs.windows }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            android:
              - 'lib/**'
              - 'android/**'
              - 'pubspec.yaml'
            windows:
              - 'lib/**'
              - 'windows/**'
              - 'pubspec.yaml'

  build-windows:
    needs: changes
    if: ${{ needs.changes.outputs.windows == 'true' }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\AppData\Local\Pub\Cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true # Verified: Enabled per Architect Directive

      - name: Cache Windows Assets
        id: assets-cache
        uses: actions/cache@v4
        with:
          path: assets
          key: windows-assets-v2-${{ hashFiles('tool/setup_core.dart') }}

      - name: Setup Core Assets (Download Binaries)
        run: |
          flutter pub get
          dart run tool/setup_core.dart

      - name: Build iVPN Windows
        run: |
          flutter pub get
          flutter build windows --release

      - name: Compress Windows Release
        shell: pwsh
        run: Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath ivpn-windows.zip -Force

      - name: Create Release and Upload Windows
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          files: ivpn-windows.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    needs: changes
    if: ${{ needs.changes.outputs.android == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache Flutter
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true # Verified: Enabled per Architect Directive

      - name: Clean Build
        run: flutter clean

      - name: Cache Android Assets
        id: android-assets-cache
        uses: actions/cache@v4
        with:
          path: assets
          key: android-assets-v2-${{ hashFiles('tool/setup_core.dart') }}

      - name: Setup Core Assets (Download Binaries)
        run: |
          flutter pub get
          dart run tool/setup_core.dart

      - name: Cache AARs
        id: aar-cache
        uses: actions/cache@v4
        with:
          path: android/app/libs
          key: ${{ runner.os }}-aar-${{ hashFiles('android/app/build.gradle.kts') }}

      - name: Download all local dependencies
        if: steps.aar-cache.outputs.cache-hit != 'true'
        run: |
          # 1. Create libs folder
          mkdir -p android/app/libs

          # 2. Download Libbox (VPN Core) - As requested, place securely in libs
          echo "Downloading Libbox..."
          curl -L -o android/app/libs/libbox.aar "https://raw.githubusercontent.com/singbox-android/libbox/refs/heads/main/libbox.aar"

          # 3. Download Terminal View (UI) - Update to v0.118.3
          echo "Downloading Terminal View..."
          curl -L -A "Mozilla/5.0" -o android/app/libs/terminal-view.aar "https://jitpack.io/com/github/termux/termux-app/terminal-view/v0.118.3/terminal-view-v0.118.3.aar"

          # 4. Download Terminal Emulator (Logic) - Update to v0.118.3
          echo "Downloading Terminal Emulator..."
          curl -L -A "Mozilla/5.0" -o android/app/libs/terminal-emulator.aar "https://jitpack.io/com/github/termux/termux-app/terminal-emulator/v0.118.3/terminal-emulator-v0.118.3.aar"

          # 5. Verify file sizes (Ensure they are not 35 bytes error messages)
          ls -lh android/app/libs/

      - name: Verify AARs
        run: ls -lh android/app/libs/

      # Verified clean build environment
      - name: Build APK
        run: |
          flutter pub get
          yes | flutter doctor --android-licenses || true
          flutter build apk --split-per-abi --release

      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          files: build/app/outputs/flutter-apk/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
